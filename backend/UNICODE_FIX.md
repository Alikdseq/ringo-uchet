# Исправление проблемы UnicodeDecodeError в psycopg2

## Проблема

При выполнении миграций Django на Windows возникала ошибка:
```
UnicodeDecodeError: 'utf-8' codec can't decode byte 0xdd in position 47: invalid continuation byte
```

**Причина:** Системные переменные Windows (USERNAME, USERPROFILE) содержат кириллицу, а libpq (C библиотека PostgreSQL) читает их через Windows API в системной кодировке (Windows-1251), после чего psycopg2 пытается декодировать их как UTF-8, что вызывает ошибку.

## Применённые исправления

### 1. Установка PYTHONUTF8=1 в manage.py

В файле `manage.py` добавлена автоматическая установка `PYTHONUTF8=1` перед импортом Django. Это заставляет Python интерпретировать все строки как UTF-8 и влияет на то, как Python передает данные в C библиотеки.

**Файл:** `backend/manage.py`

### 2. Очистка переменных окружения PostgreSQL

В нескольких местах добавлена очистка переменных окружения PostgreSQL:
- `PGHOST`
- `PGUSER`
- `PGPASSWORD`
- `PGDATABASE`
- `PGPORT`
- `PGPASSFILE`

Это предотвращает чтение libpq системных переменных Windows и заставляет использовать только параметры из Django settings.

**Файлы:** 
- `backend/manage.py`
- `backend/ringo_backend/__init__.py`
- `backend/ringo_backend/settings/base.py`

### 3. Monkey patch для psycopg2.connect

Добавлен monkey patch для `psycopg2.connect`, который:
- Перехватывает вызовы подключения к PostgreSQL
- Временно очищает переменные окружения PostgreSQL перед подключением
- Явно формирует DSN строку с правильной кодировкой UTF-8
- Восстанавливает переменные окружения после подключения

**Файлы:**
- `backend/manage.py` (патч через перехват импорта)
- `backend/ringo_backend/__init__.py` (патч при инициализации модуля)

### 3. Вспомогательный скрипт для глобальной установки PYTHONUTF8

Создан PowerShell скрипт `setup_python_utf8.ps1` для опциональной глобальной установки `PYTHONUTF8=1` в системных переменных Windows.

**Файл:** `backend/setup_python_utf8.ps1`

## Использование

### Автоматическое исправление (рекомендуется)

Исправления применены автоматически. Просто запускайте миграции как обычно:

```powershell
python manage.py migrate
```

### Опциональная глобальная установка PYTHONUTF8

Если вы хотите установить `PYTHONUTF8=1` глобально для всей системы (необязательно, так как это уже делается в `manage.py`):

```powershell
# Для текущего пользователя
.\setup_python_utf8.ps1 -UserOnly

# Для всей системы (требуются права администратора)
.\setup_python_utf8.ps1
```

После установки может потребоваться перезапустить терминал.

## Проверка исправления

Проверьте, что миграции работают:

```powershell
python manage.py migrate catalog
```

Если ошибка больше не возникает, исправление работает корректно.

## Технические детали

### Как это работает

1. **PYTHONUTF8=1**: Заставляет Python интерпретировать все строки как UTF-8 на уровне интерпретатора, что влияет на передачу данных в C библиотеки через ctypes и другие механизмы.

2. **Пустые переменные окружения PostgreSQL**: libpq проверяет переменные окружения `PGHOST`, `PGUSER` и т.д. перед использованием параметров из DSN. Установка пустых значений заставляет libpq игнорировать системные переменные Windows и использовать только параметры, переданные из Django.

### Почему это решает проблему

- **PYTHONUTF8=1** гарантирует, что Python правильно обрабатывает строки с кириллицей при передаче в C библиотеки
- **Пустые переменные окружения** предотвращают чтение libpq системных переменных Windows, которые содержат кириллицу в системной кодировке

## Альтернативные решения

Если по какой-то причине эти исправления не работают, можно попробовать:

1. **Использовать DATABASE_URL**: Настроить Django на использование `DATABASE_URL` вместо отдельных параметров
2. **Обновить psycopg2**: `pip install --upgrade psycopg2-binary`
3. **Изменить имя пользователя Windows**: Создать пользователя с именем на латинице (не рекомендуется)

## Дополнительная информация

Подробный анализ проблемы см. в файле `PROBLEM_ANALYSIS.md`.

