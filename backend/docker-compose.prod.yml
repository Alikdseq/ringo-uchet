version: '3.8'

services:
  api:
    image: ${DOCKER_REGISTRY:-ghcr.io}/${IMAGE_NAME:-ringo-backend}:${IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      - DJANGO_SETTINGS_MODULE=ringo_backend.settings.prod
      - POSTGRES_HOST=${DB_HOST}
      - POSTGRES_PORT=${DB_PORT}
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND}
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_BUCKET=${AWS_BUCKET}
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}
    command: gunicorn ringo_backend.wsgi:application --bind 0.0.0.0:8000 --workers 4 --timeout 120 --access-logfile - --error-logfile -
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - ringo-net
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  celery-worker:
    image: ${DOCKER_REGISTRY:-ghcr.io}/${IMAGE_NAME:-ringo-backend}:${IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      - DJANGO_SETTINGS_MODULE=ringo_backend.settings.prod
      - POSTGRES_HOST=${DB_HOST}
      - POSTGRES_PORT=${DB_PORT}
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND}
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_BUCKET=${AWS_BUCKET}
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - CELERY_WORKER_CONCURRENCY=${CELERY_WORKER_CONCURRENCY:-4}
      - CELERY_WORKER_MAX_TASKS_PER_CHILD=${CELERY_WORKER_MAX_TASKS_PER_CHILD:-1000}
      - CELERY_WORKER_AUTOSCALER=${CELERY_WORKER_AUTOSCALER:-true}
      - CELERY_WORKER_AUTOSCALER_MIN=${CELERY_WORKER_AUTOSCALER_MIN:-2}
      - CELERY_WORKER_AUTOSCALER_MAX=${CELERY_WORKER_AUTOSCALER_MAX:-10}
    command: >
      celery -A ringo_backend worker
      --loglevel=info
      --concurrency=${CELERY_WORKER_CONCURRENCY:-4}
      --max-tasks-per-child=${CELERY_WORKER_MAX_TASKS_PER_CHILD:-1000}
      --autoscale=${CELERY_WORKER_AUTOSCALER_MAX:-10},${CELERY_WORKER_AUTOSCALER_MIN:-2}
      --queues=default,finance,notifications,orders
    healthcheck:
      test: ["CMD", "celery", "-A", "ringo_backend", "inspect", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - ringo-net
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s

  celery-beat:
    image: ${DOCKER_REGISTRY:-ghcr.io}/${IMAGE_NAME:-ringo-backend}:${IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      - DJANGO_SETTINGS_MODULE=ringo_backend.settings.prod
      - POSTGRES_HOST=${DB_HOST}
      - POSTGRES_PORT=${DB_PORT}
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - CELERY_BROKER_URL=${CELERY_BROKER_URL}
      - CELERY_RESULT_BACKEND=${CELERY_RESULT_BACKEND}
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
    command: celery -A ringo_backend beat --loglevel=info
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "celery.*beat"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - ringo-net
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

networks:
  ringo-net:
    driver: bridge

