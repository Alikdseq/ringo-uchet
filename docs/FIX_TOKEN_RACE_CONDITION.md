# ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: Race Condition —Å —Ç–æ–∫–µ–Ω–∞–º–∏

## ‚ùå –ü–†–û–ë–õ–ï–ú–ê

**–ü–æ—Å–ª–µ –ª–æ–≥–∏–Ω–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–∞ –æ—à–∏–±–∫–∞ 401:**
- `POST /api/v1/token/` ‚Üí 200 (–ø–æ–ª—É—á–µ–Ω –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω)
- `GET /api/v1/users/me/` ‚Üí 401 (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω)
- `GET /api/v1/users/me/` ‚Üí 200 (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º)

**–ü—Ä–∏—á–∏–Ω–∞:**
1. –í `auth_service.dart` –º–µ—Ç–æ–¥ `login()` –¥–µ–ª–∞–ª –∑–∞–ø—Ä–æ—Å `/users/me/` **–î–û** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤ SecureStorage
2. `AuthInterceptor` —á–∏—Ç–∞–µ—Ç —Ç–æ–∫–µ–Ω –∏–∑ SecureStorage –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
3. –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞—Ä—ã–π —Ç–æ–∫–µ–Ω –∏–ª–∏ –∑–∞–ø—Ä–æ—Å –∏–¥–µ—Ç –±–µ–∑ —Ç–æ–∫–µ–Ω–∞ ‚Üí 401

---

## ‚úÖ –†–ï–®–ï–ù–ò–ï

### 1. –£–±—Ä–∞–ª –∑–∞–ø—Ä–æ—Å `/users/me/` –∏–∑ `auth_service.login()`

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ç–æ–¥ `login()` –¥–µ–ª–∞–ª –∑–∞–ø—Ä–æ—Å `/users/me/` –¥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:** –£–±—Ä–∞–ª –∑–∞–ø—Ä–æ—Å –∏–∑ `auth_service.login()` - —Ç–µ–ø–µ—Ä—å –æ–Ω —Ç–æ–ª—å–∫–æ –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–∫–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –ó–∞–ø—Ä–æ—Å `/users/me/` –¥–µ–ª–∞–µ—Ç—Å—è –≤ `AuthNotifier` **–ü–û–°–õ–ï** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞.

**–§–∞–π–ª:** `mobile/lib/features/auth/services/auth_service.dart`

---

### 2. –î–æ–±–∞–≤–∏–ª –ø—Ä–æ–≤–µ—Ä–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –≤ `AuthNotifier`

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–æ–∫–µ–Ω –º–æ–≥ –Ω–µ —É—Å–ø–µ—Ç—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
- –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è - –ø–æ–≤—Ç–æ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –Ω–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (50ms) –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º `/users/me/` –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏

**–§–∞–π–ª:** `mobile/lib/features/auth/notifiers/auth_notifier.dart`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```dart
// –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω—ã –°–ò–ù–•–†–û–ù–ù–û –ø–µ—Ä–µ–¥ –ª—é–±—ã–º–∏ –∑–∞–ø—Ä–æ—Å–∞–º–∏
await _secureStorage.saveAccessToken(authResponse.access);
await _secureStorage.saveRefreshToken(authResponse.refresh);

// –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–∞–º–∏
final savedToken = await _secureStorage.getAccessToken();
if (savedToken != authResponse.access) {
  // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏–ª—Å—è, –ø–æ–≤—Ç–æ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  await _secureStorage.saveAccessToken(authResponse.access);
  await _secureStorage.saveRefreshToken(authResponse.refresh);
}

// –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏–∏ —á—Ç–æ —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ SecureStorage
await Future.delayed(const Duration(milliseconds: 50));

// –¢–µ–ø–µ—Ä—å –¥–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å /users/me/ - —Ç–æ–∫–µ–Ω —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
final user = await _authService.getCurrentUser();
```

---

### 3. –£–ª—É—á—à–∏–ª `AuthInterceptor`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ:** –î–æ–±–∞–≤–ª–µ–Ω –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —á—Ç–æ —Ç–æ–∫–µ–Ω –≤—Å–µ–≥–¥–∞ —á–∏—Ç–∞–µ—Ç—Å—è —Å–≤–µ–∂–∏–º –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º –∑–∞–ø—Ä–æ—Å–æ–º.

**–§–∞–π–ª:** `mobile/lib/core/network/interceptors/auth_interceptor.dart`

---

## üìã –ü–û–°–õ–ï–î–û–í–ê–¢–ï–õ–¨–ù–û–°–¢–¨ –¢–ï–ü–ï–†–¨ –ü–†–ê–í–ò–õ–¨–ù–ê–Ø

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. `POST /token/` ‚Üí –ø–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
2. `GET /users/me/` ‚Üí **401** (—Ç–æ–∫–µ–Ω –µ—â–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ SecureStorage)
3. `GET /users/me/` ‚Üí 200 (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å)

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
1. `POST /token/` ‚Üí –ø–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
2. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ SecureStorage
3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω
4. –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (50ms)
5. `GET /users/me/` ‚Üí **200** (—Ç–æ–∫–µ–Ω —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–æ–≤—ã–π)

---

## ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢

**–¢–µ–ø–µ—Ä—å:**
- ‚úÖ –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è **–î–û** –ª—é–±—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —á—Ç–æ —Ç–æ–∫–µ–Ω –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω
- ‚úÖ –ó–∞–ø—Ä–æ—Å—ã `/users/me/` –¥–µ–ª–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ **–ü–û–°–õ–ï** —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞
- ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ 401 –∏–∑-–∑–∞ race condition

---

## üöÄ –î–ï–ü–õ–û–ô

**–ù—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç—å:**

```powershell
cd C:\ringo-uchet\mobile
flutter build web --release --base-href /
```

–ó–∞—Ç–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ `docs/DEPLOY_OPTIMIZATIONS.md`.

---

**–ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –æ—à–∏–±–∫–∏ 401 –∏–∑-–∑–∞ —Å—Ç–∞—Ä—ã—Ö —Ç–æ–∫–µ–Ω–æ–≤ –∏—Å—á–µ–∑–Ω—É—Ç!**

