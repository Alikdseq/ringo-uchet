# Отслеживание расходов на топливо по технике

## Описание изменений

Исправлена система учета расходов на топливо. Теперь каждая единица техники в заявке имеет свои расходы на топливо, которые отслеживаются отдельно.

## Что изменилось

### 1. Модель OrderItem

Добавлено поле `fuel_expense` для хранения расходов на топливо для каждой единицы техники:

```python
fuel_expense = models.DecimalField(
    max_digits=12,
    decimal_places=2,
    null=True,
    blank=True,
    default=None,
    verbose_name="Расходы на топливо",
    help_text="Расходы на топливо для данной техники",
)
```

### 2. Сериализатор OrderItemSerializer

Добавлено поле `fuel_expense` в сериализатор для приема расходов на топливо при создании/обновлении позиции техники.

### 3. Логика завершения заявки

При завершении заявки (`/api/orders/{id}/complete/`) расходы на топливо создаются для каждой единицы техники отдельно на основе значения `fuel_expense` из `OrderItem`.

**Старая логика (удалена):**
- Общий расход на топливо (`fuel_expense`) привязывался к первой технике в заявке

**Новая логика:**
- Каждая единица техники может иметь свои расходы на топливо
- Расходы создаются только для техники, у которой указан `fuel_expense > 0`
- Каждый расход привязывается к соответствующей технике

### 4. Отчеты

#### Общий отчет (`/api/reports/summary/`)

Добавлено поле `expenses_fuel` - суммирующий расход по топливу, который показывает сумму всех расходов на топливо за период.

```json
{
  "expenses": "10000.00",      // Все расходы
  "expenses_fuel": "5000.00",  // Только расходы на топливо
  "salaries": "2000.00",
  "margin": "3000.00"
}
```

#### Отчет по технике (`/api/reports/equipment/`)

Добавлено поле `fuel_expenses` для каждой единицы техники, показывающее расходы на топливо именно для этой техники.

```json
[
  {
    "equipment_id": 1,
    "equipment_name": "Экскаватор JCB 3CX",
    "code": "EXC-001",
    "status": "available",
    "total_hours": "120.00",
    "revenue": "180000.00",
    "expenses": "15000.00",      // Все расходы для этой техники
    "fuel_expenses": "8000.00"    // Расходы на топливо для этой техники
  }
]
```

## Использование API

### Завершение заявки с указанием расходов на топливо

При завершении заявки в массиве `items` для каждой единицы техники можно указать `fuel_expense`:

```json
POST /api/orders/{id}/complete/
{
  "end_dt": "2025-12-04T18:00:00Z",
  "comment": "Работы завершены",
  "items": [
    {
      "item_type": "equipment",
      "ref_id": 1,
      "metadata": {
        "shifts": 2,
        "hours": 4
      },
      "fuel_expense": "5000.00"  // Расходы на топливо для этой техники
    },
    {
      "item_type": "equipment",
      "ref_id": 2,
      "metadata": {
        "shifts": 1,
        "hours": 0
      },
      "fuel_expense": "3000.00"  // Расходы на топливо для другой техники
    }
  ]
}
```

### Получение отчетов

#### Общий отчет с расходами на топливо

```bash
GET /api/reports/summary/?from=2025-12-01&to=2025-12-31
```

Ответ включает поле `expenses_fuel` с суммой всех расходов на топливо.

#### Отчет по технике с расходами на топливо

```bash
GET /api/reports/equipment/?from=2025-12-01&to=2025-12-31
```

Каждая запись в ответе включает поле `fuel_expenses` с расходами на топливо для данной техники.

## Миграция базы данных

Создана и применена миграция `0004_add_fuel_expense_to_order_item.py`, которая добавляет поле `fuel_expense` в таблицу `orders_orderitem`.

## Обратная совместимость

- Старые заявки без указания `fuel_expense` продолжают работать корректно
- Поле `fuel_expense` является опциональным (nullable)
- Если `fuel_expense` не указан или равен 0, расходы на топливо не создаются для данной техники

## Админка Django

Поле `fuel_expense` отображается в админке в разделе позиций заказа (`OrderItemInline`) как readonly поле.

