# Real-Time Синхронизация данных

## Реализовано

Система мгновенной синхронизации данных между всеми пользователями приложения без необходимости обновления страницы.

---

## Механизмы синхронизации

### 1. Автоматический Polling (refetchInterval)

Критичные данные автоматически обновляются через заданные интервалы:

- **Список заявок**: каждые 5 секунд
- **Детальная страница заявки**: каждые 3 секунды  
- **Список операторов**: каждые 5 секунд

### 2. Focus Refetch

При возврате пользователя на вкладку браузера данные автоматически обновляются:
- Включено `refetchOnWindowFocus: true` в глобальных настройках
- Включено `refetchOnReconnect: true` для обновления при восстановлении сети

### 3. Автоматическая инвалидация при мутациях

При любом изменении данных автоматически инвалидируются все связанные запросы:

- Создание заявки → обновляются списки заявок, дашборды
- Изменение статуса заявки → обновляются списки, отчёты, дашборды
- Создание оператора → обновляются списки операторов
- Завершение заявки → обновляются все связанные данные

### 4. Optimistic Updates

Для мгновенного отображения изменений используется оптимистичное обновление:

- При смене статуса заявки → статус меняется мгновенно, затем синхронизируется с сервером
- При ошибке → автоматический откат к предыдущему состоянию

---

## Что синхронизируется

### Заявки
- ✅ Создание новой заявки → сразу видна у всех пользователей
- ✅ Изменение статуса → мгновенно отображается у всех
- ✅ Редактирование заявки → изменения видны сразу
- ✅ Завершение заявки → статус обновляется мгновенно

### Операторы
- ✅ Создание нового оператора → сразу виден в каталоге
- ✅ Редактирование оператора → изменения видны мгновенно
- ✅ Удаление оператора → удаляется из списка сразу

### Другие данные
- ✅ Отчёты обновляются при изменении заявок
- ✅ Дашборды синхронизируются автоматически
- ✅ Зарплаты операторов обновляются при завершении заявок

---

## Технические детали

### Настройки React Query

```typescript
// Глобальные настройки (queryClient.ts)
{
  staleTime: 30_000,           // Данные свежие 30 секунд
  refetchOnWindowFocus: true,  // Обновление при фокусе
  refetchOnReconnect: true,    // Обновление при восстановлении сети
  refetchOnMount: true,        // Обновление при монтировании
}

// Мутации автоматически инвалидируют все запросы
mutations: {
  onSettled: () => {
    queryClient.invalidateQueries();
  }
}
```

### Интервалы обновления

| Данные | Интервал | staleTime |
|--------|----------|-----------|
| Список заявок | 5 сек | 3 сек |
| Детальная заявка | 3 сек | 2 сек |
| Список операторов | 5 сек | 3 сек |

---

## Примеры работы

### Сценарий 1: Админ создал заявку
1. Админ создаёт заявку → заявка сохраняется на сервере
2. Автоматическая инвалидация → все запросы списка заявок обновляются
3. Оператор видит новую заявку → через 0-5 секунд (в зависимости от времени последнего обновления)

### Сценарий 2: Оператор изменил статус
1. Оператор нажимает "Одобрить" → optimistic update (мгновенно)
2. Запрос отправляется на сервер → статус меняется на сервере
3. Автоматическая инвалидация → все пользователи видят изменение через 0-5 секунд
4. Админ видит обновлённый статус → без обновления страницы

### Сценарий 3: Админ создал оператора
1. Админ создаёт оператора → оператор сохраняется на сервере
2. Автоматическая инвалидация → список операторов обновляется
3. Все пользователи видят нового оператора → через 0-5 секунд

---

## Производительность

- **Минимальная нагрузка**: запросы выполняются только когда данные устарели
- **Умное кэширование**: данные считаются свежими в течение заданного времени
- **Оптимистичные обновления**: мгновенный отклик UI без ожидания сервера
- **Автоматическая отмена**: конфликтующие запросы отменяются автоматически

---

## Настройка интервалов

Если нужно изменить частоту обновлений, отредактируйте параметры в соответствующих файлах:

- `frontend/src/app/(app)/orders/page.tsx` - список заявок
- `frontend/src/app/(app)/orders/[orderId]/page.tsx` - детальная заявка
- `frontend/src/app/(app)/catalog/operators/page.tsx` - список операторов

```typescript
refetchInterval: 5000,  // Интервал в миллисекундах (5000 = 5 сек)
staleTime: 3000,        // Время свежести данных (3000 = 3 сек)
```

---

## Будущие улучшения

Для ещё более быстрой синхронизации можно добавить:

1. **WebSockets** - мгновенная синхронизация без polling
2. **Server-Sent Events (SSE)** - односторонняя синхронизация от сервера
3. **BroadcastChannel API** - синхронизация между вкладками браузера

Текущая реализация обеспечивает отличный баланс между производительностью и простотой поддержки.

