# Alertmanager –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤

global:
  resolve_timeout: 5m
  # Slack webhook URL (–∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤ secrets)
  slack_api_url: '${SLACK_WEBHOOK_URL}'
  # Telegram bot token –∏ chat ID (–∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤ secrets)
  telegram_api_url: 'https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage'
  telegram_chat_id: '${TELEGRAM_CHAT_ID}'

# –®–∞–±–ª–æ–Ω—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤
route:
  receiver: 'default'
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  routes:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å—Ä–∞–∑—É
    - match:
        severity: critical
      receiver: 'critical-alerts'
      continue: true
    
    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –≥—Ä—É–ø–ø–∏—Ä—É—é—Ç—Å—è
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      repeat_interval: 6h

# –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
receivers:
  - name: 'default'
    slack_configs:
      - channel: '#ringo-alerts'
        title: '{{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'
        send_resolved: true

  - name: 'critical-alerts'
    slack_configs:
      - channel: '#ringo-alerts-critical'
        title: 'üö® CRITICAL: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Severity:* {{ .Labels.severity }}
          *Component:* {{ .Labels.component }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          *Instance:* {{ .Labels.instance }}
          {{ end }}
        send_resolved: true
        http_config:
          follow_redirects: true
    
    telegram_configs:
      - bot_token: '${TELEGRAM_BOT_TOKEN}'
        chat_id: ${TELEGRAM_CHAT_ID}
        message: |
          üö® *CRITICAL ALERT*
          {{ range .Alerts }}
          *{{ .Labels.alertname }}*
          {{ .Annotations.summary }}
          {{ .Annotations.description }}
          {{ end }}
        parse_mode: 'Markdown'
        disable_notifications: false

  - name: 'warning-alerts'
    slack_configs:
      - channel: '#ringo-alerts'
        title: '‚ö†Ô∏è WARNING: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.summary }}\n{{ .Annotations.description }}{{ end }}'
        send_resolved: true

# –ò–Ω–≥–∏–±–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ–¥–∞–≤–ª–µ–Ω–∏–µ) –∞–ª–µ—Ä—Ç–æ–≤
inhibit_rules:
  # –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞–ª–µ—Ä—Ç—ã –æ –≤—ã—Å–æ–∫–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
  - source_match:
      severity: 'critical'
      alertname: 'ServerDown'
    target_match:
      severity: 'warning'
    equal: ['instance']
  
  # –ï—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∞–ª–µ—Ä—Ç—ã –æ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
  - source_match:
      severity: 'critical'
      alertname: 'APIDown'
    target_match:
      severity: 'warning'
      alertname: 'HighAPILatency'
    equal: ['instance']

