# ✅ Проактивное обновление токенов

## Проблема
Когда пользователь открывает приложение через 2-3 часа после последнего использования, токены могли истечь, и пользователь видел экран ввода пароля.

## Решение
Реализовано **проактивное обновление токенов** при открытии приложения.

---

## Как это работает

### При открытии приложения (`_checkAuthStatus()`)

1. **Мгновенное отображение кэша**
   - Пользователь сразу видит главный экран с кэшированными данными
   - Не видит белый экран или экран входа

2. **Проактивное обновление токенов**
   - Проверяем наличие refresh token
   - Если есть → **сразу обновляем** access token (даже если он еще не истек)
   - Получаем свежие токены ДО того как они истекут

3. **Автоматический вход (fallback)**
   - Если refresh token истек или обновление не удалось
   - Используем сохраненный пароль для автоматического входа
   - Получаем новые токены
   - Пользователь **не видит экран входа**

4. **Обновление данных пользователя**
   - После успешного обновления токенов
   - Обновляем данные пользователя с сервера в фоне
   - Пользователь видит актуальные данные

---

## Сценарии использования

### Сценарий 1: Refresh token валиден
```
Открытие приложения
  ↓
Есть refresh token? ДА
  ↓
Обновляем access token → УСПЕХ ✅
  ↓
Обновляем данные пользователя в фоне
  ↓
Пользователь видит главный экран с актуальными данными
```

### Сценарий 2: Refresh token истек
```
Открытие приложения
  ↓
Есть refresh token? ДА, но ИСТЕК
  ↓
Обновление токена → ОШИБКА
  ↓
Есть сохраненный пароль? ДА
  ↓
Автоматический вход с паролем → УСПЕХ ✅
  ↓
Получаем новые токены
  ↓
Пользователь видит главный экран (БЕЗ ввода пароля)
```

### Сценарий 3: Нет токенов вообще
```
Открытие приложения
  ↓
Нет токенов
  ↓
Есть сохраненный пароль? ДА
  ↓
Автоматический вход с паролем → УСПЕХ ✅
  ↓
Получаем новые токены
  ↓
Пользователь видит главный экран (БЕЗ ввода пароля)
```

---

## Преимущества

✅ **Пользователь не видит экран входа** - вход происходит автоматически  
✅ **Быстрее** - обновление токена быстрее полного входа  
✅ **Меньше нагрузка на сервер** - реже нужен полный вход  
✅ **Свежие токены** - обновляем токены проактивно, до истечения  
✅ **Надежность** - если обновление не удалось, используем автоматический вход

---

## Технические детали

### Метод `_checkAuthStatus()` (строки 54-138)

**Логика:**
1. Загружаем кэш пользователя для мгновенного отображения
2. Проверяем наличие refresh token
3. Если есть → обновляем access token
4. Если обновление успешно → обновляем данные в фоне
5. Если обновление не удалось → автоматический вход с паролем
6. Если нет пароля → проверяем access token (может быть еще валиден)
7. Если ничего не работает → показываем экран входа (только если нет кэша)

### Ключевые изменения

**До:**
- Токены обновлялись только при получении 401 ошибки
- Пользователь мог увидеть экран входа

**После:**
- Токены обновляются **проактивно** при открытии приложения
- Если refresh token валиден → токены обновляются сразу
- Если refresh token истек → автоматический вход с паролем
- Пользователь **никогда не видит экран входа** (если пароль сохранен)

---

## Результат

Теперь пользователь:
- ✅ Открывает приложение через 2-3 часа
- ✅ Видит главный экран **мгновенно** (из кэша)
- ✅ Токены обновляются **автоматически** в фоне
- ✅ **Не вводит пароль** - вход происходит автоматически
- ✅ Видит актуальные данные после обновления

**Пароль нужно ввести только один раз** - дальше все работает автоматически!

