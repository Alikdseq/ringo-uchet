# Как работает вход в приложение

## Текущая реализация автоматического входа

### 1. При первом входе (пользователь вводит телефон/email и пароль)

После успешного входа:
- ✅ Сохраняются **токены** (access + refresh) в `SecureStorage`
- ✅ Сохраняются **телефон/email** в `SecureStorage`
- ✅ Сохраняется **пароль** в `SecureStorage` (в зашифрованном виде)
- ✅ Сохраняются **данные пользователя** (имя, роль и т.д.) в `SecureStorage`

**Важно:** Все данные сохраняются **НАВСЕГДА** и не удаляются при выходе из приложения.

---

### 2. При повторном открытии приложения

**Шаг 1: Проверка кэша пользователя**
- Приложение загружает данные пользователя из кэша (`SecureStorage`)
- Если данные есть → пользователь **МГНОВЕННО** видит главный экран
- Интерфейс показывается сразу, без ожидания

**Шаг 2: Проверка токена**
- Если есть **токен** → данные обновляются с сервера в фоне
- Если токена нет → переходим к шагу 3

**Шаг 3: Автоматический вход (если токена нет)**
- Приложение проверяет, есть ли сохраненные телефон/email и пароль
- Если данные есть → **автоматически выполняет вход** без показа экрана ввода пароля
- Пользователь сразу попадает на главный экран

**Шаг 4: Показ экрана входа (только если нет данных)**
- Экран ввода пароля показывается **ТОЛЬКО** если:
  - Нет кэша пользователя
  - Нет сохраненных телефона/email и пароля

---

### 3. При выходе из приложения (logout)

- ✅ Очищаются **токены** (access + refresh)
- ✅ Очищаются **данные пользователя** (имя, роль и т.д.)
- ✅ **НЕ очищаются** телефон/email и пароль (они остаются для следующего автоматического входа)

**Результат:** При следующем открытии приложения автоматический вход произойдет автоматически.

---

## Улучшения в новой версии

### Изменение 1: Синхронный автоматический вход

**Было:** Автоматический вход происходил в фоне через `Future.microtask`, из-за чего мог показываться экран входа.

**Стало:** Автоматический вход происходит **сразу и синхронно** при проверке статуса авторизации. Пользователь не видит экран входа, если есть сохраненные данные.

### Изменение 2: Улучшенная логика показа экранов

**Было:** 
- Если `isAuthenticated = false` → показывался экран входа

**Стало:**
- Если `isAuthenticated = true` ИЛИ `isLoading = true` → показывается главный экран
- Экран входа показывается **только** если точно известно, что пользователь не авторизован и нет сохраненных данных

---

## Результат для пользователя

✅ **Первый раз:** Вводит телефон/email и пароль → попадает в приложение

✅ **Все последующие разы:** 
- Открывает приложение → **МГНОВЕННО** видит главный экран
- Никакого ввода пароля не требуется
- Никаких задержек и экранов входа

✅ **Даже после закрытия приложения:** При следующем открытии автоматический вход произойдет автоматически, так как телефон/email и пароль сохранены.

---

## Технические детали

### Где хранятся данные:
- **SecureStorage** (Flutter Secure Storage) - безопасное хранилище, использует:
  - Android: EncryptedSharedPreferences
  - iOS: Keychain
  - Web: Encrypted localStorage

### Безопасность:
- Пароль хранится в зашифрованном виде через SecureStorage
- Токены автоматически обновляются через refresh token
- При истечении токена происходит автоматический вход с сохраненными данными

### Что происходит при смене пароля:
Если пользователь меняет пароль на сервере, но приложение еще использует старый сохраненный пароль:
- Автоматический вход не удастся
- Пользователь увидит экран входа
- После ввода нового пароля → новый пароль сохранится и будет использоваться для следующего автоматического входа

