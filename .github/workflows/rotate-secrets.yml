name: Rotate Secrets

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü –≤ –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch:

jobs:
  rotate-django-secret:
    name: Rotate Django SECRET_KEY
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Generate new SECRET_KEY
        id: generate-secret
        run: |
          NEW_SECRET=$(openssl rand -hex 32)
          echo "new_secret=$NEW_SECRET" >> $GITHUB_OUTPUT
      
      - name: Update staging SECRET_KEY
        run: |
          gh secret set STAGING_DJANGO_SECRET_KEY --body "${{ steps.generate-secret.outputs.new_secret }}" --env staging
      
      - name: Generate production SECRET_KEY
        id: generate-prod-secret
        run: |
          NEW_SECRET=$(openssl rand -hex 32)
          echo "new_secret=$NEW_SECRET" >> $GITHUB_OUTPUT
      
      - name: Update production SECRET_KEY
        run: |
          gh secret set PROD_DJANGO_SECRET_KEY --body "${{ steps.generate-prod-secret.outputs.new_secret }}" --env production
      
      - name: Create issue for manual rotation
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîê Secret Rotation Required',
              body: `New SECRET_KEY has been generated and stored in GitHub Secrets.
            
            **Action Required:**
            1. Update application servers with new SECRET_KEY
            2. Restart services
            3. Verify application is working
            4. Close this issue
            
            **Note:** Old SECRET_KEY will remain valid until all services are updated.`,
              labels: ['security', 'maintenance']
            })

  notify-admins:
    name: Notify Administrators
    runs-on: ubuntu-latest
    needs: [rotate-django-secret]
    if: always()
    steps:
      - name: Send notification
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Slack/Telegram
        run: |
          echo "Secret rotation completed. Check GitHub Issues for details."

